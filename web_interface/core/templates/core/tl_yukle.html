<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TL YÃ¼kleme - KontÃ¶r Otomasyonu</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gradient-to-br from-gray-50 to-blue-50 font-sans leading-normal tracking-normal min-h-screen">

    <nav class="bg-gradient-to-r from-blue-700 to-indigo-800 p-4 shadow-xl">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <div class="bg-white p-2 rounded-full opacity-20"></div>
                <h1 class="text-white text-lg sm:text-2xl font-bold tracking-wide">KontÃ¶r Otomasyonu</h1>
            </div>
            <!-- Hamburger Button (Mobile) -->
            <button id="mobile-menu-btn" class="md:hidden text-white focus:outline-none"
                onclick="document.getElementById('mobile-menu').classList.toggle('hidden')">
                <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16">
                    </path>
                </svg>
            </button>
            <!-- Desktop Nav -->
            <div class="hidden md:flex space-x-6 items-center">
                <a href="{% url 'dashboard' %}"
                    class="text-white font-medium hover:text-blue-200 transition transform hover:scale-105">Panel</a>
                <a href="{% url 'auto_orders' %}"
                    class="text-white font-medium hover:text-blue-200 transition transform hover:scale-105">Otomatik
                    Ä°ÅŸlemler</a>
                <a href="{% url 'packages' %}"
                    class="text-white font-medium hover:text-blue-200 transition transform hover:scale-105">KÃ¼pÃ¼rler</a>
                <a href="{% url 'bulk_orders' %}"
                    class="text-white font-medium hover:text-blue-200 transition transform hover:scale-105">Toplu
                    Ä°ÅŸlem</a>
                <a href="{% url 'tl_load' %}"
                    class="text-blue-200 font-bold border-b-2 border-blue-200 transition transform hover:scale-105">TL
                    YÃ¼kle</a>
                <a href="{% url 'cards' %}"
                    class="text-white font-medium hover:text-blue-200 transition transform hover:scale-105">KartlarÄ±m</a>
                <a href="{% url 'logout' %}"
                    class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-full shadow-md transition transform hover:scale-105 font-medium text-sm">Ã‡Ä±kÄ±ÅŸ
                    Yap</a>
            </div>
        </div>
        <!-- Mobile Menu (Hidden by default) -->
        <div id="mobile-menu" class="hidden md:hidden mt-4 pb-2 border-t border-white/20 pt-4 space-y-3">
            <a href="{% url 'dashboard' %}" class="block text-white font-medium hover:text-blue-200 transition py-2">ðŸ“Š
                Panel</a>
            <a href="{% url 'auto_orders' %}" class="block text-white font-medium hover:text-blue-200 transition py-2">âš¡
                Otomatik Ä°ÅŸlemler</a>
            <a href="{% url 'packages' %}" class="block text-white font-medium hover:text-blue-200 transition py-2">ðŸ“¦
                KÃ¼pÃ¼rler</a>
            <a href="{% url 'bulk_orders' %}"
                class="block text-white font-medium hover:text-blue-200 transition py-2">ðŸ“‹ Toplu Ä°ÅŸlem</a>
            <a href="{% url 'tl_load' %}" class="block text-blue-200 font-bold transition py-2">ðŸ’°
                TL YÃ¼kle</a>
            <a href="{% url 'cards' %}" class="block text-white font-medium hover:text-blue-200 transition py-2">ðŸ’³
                KartlarÄ±m</a>
            <a href="{% url 'logout' %}"
                class="block bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg shadow-md transition font-medium text-sm text-center mt-2">Ã‡Ä±kÄ±ÅŸ
                Yap</a>
        </div>
    </nav>

    <div class="container mx-auto mt-4 sm:mt-8 p-3 sm:p-6 max-w-full">
        <div class="flex flex-col md:flex-row gap-4 sm:gap-8 items-start">

            <!-- LEFT SIDE: Order Form -->
            <div
                class="w-full md:w-1/3 bg-white/80 backdrop-blur-lg rounded-2xl shadow-xl p-4 sm:p-8 border border-white/20 md:sticky top-8">
                <div class="flex items-center space-x-3 mb-6 border-b border-gray-100 pb-4">
                    <div class="bg-green-100 p-2 rounded-lg">
                        <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                            </path>
                        </svg>
                    </div>
                    <h2 class="text-xl font-bold text-gray-800">TL YÃ¼kleme</h2>
                </div>

                <form id="order-form" method="POST" action="">
                    {% csrf_token %}

                    <!-- Step 1: Phone -->
                    <div id="step-phone" class="mb-6">
                        <label class="block text-gray-600 text-sm font-semibold mb-2" for="id_phone_number">
                            Telefon NumarasÄ±
                        </label>
                        <input type="text" name="phone_number" id="id_phone_number"
                            class="w-full px-4 py-2 border rounded focus:ring-2 focus:ring-green-500 outline-none transition"
                            placeholder="5XX XXX XX XX" maxlength="11" required>
                        <p class="text-xs text-gray-400 mt-2 flex items-center">
                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            Otomatik algÄ±lama aktif
                        </p>
                    </div>

                    <!-- Loading / Status Indicator -->
                    <div id="step-loading"
                        class="hidden mb-6 text-center py-6 bg-green-50/50 rounded-xl border border-green-100">
                        <div class="relative flex items-center justify-center mb-4">
                            <div id="loading-spinner"
                                class="animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-green-500 mx-auto">
                            </div>
                            <div id="error-icon" class="hidden mx-auto">
                                <svg class="w-12 h-12 text-red-500" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                        </div>

                        <h3 id="loading-text" class="text-lg font-bold text-gray-800 mb-2">BaÅŸlatÄ±lÄ±yor...</h3>

                        <!-- Dynamic Status Message -->
                        <p id="dynamic-status" class="text-green-600 font-medium text-sm animate-pulse mb-4 h-6">
                            Sistem hazÄ±rlanÄ±yor...
                        </p>

                        <!-- Warning Box -->
                        <div id="warning-box"
                            class="bg-yellow-50 mx-4 border border-yellow-200 p-3 text-left rounded-lg shadow-sm">
                            <div class="flex items-start">
                                <div class="flex-shrink-0 pt-0.5">
                                    <svg class="h-4 w-4 text-yellow-500" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd"
                                            d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"
                                            clip-rule="evenodd" />
                                    </svg>
                                </div>
                                <div class="ml-2">
                                    <p class="text-xs text-yellow-700 font-bold">
                                        Sekmeyi KapatmayÄ±nÄ±z
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Retry Button (Hidden by default) -->
                        <button type="button" id="retry-captcha-btn"
                            class="hidden mt-3 w-full bg-red-100 hover:bg-red-200 text-red-700 font-bold py-2 px-4 rounded transition">
                            âŸ³ Yenile ve Tekrar Dene
                        </button>
                    </div>

                    <!-- Step 2: Amount Selection (Hidden initially) -->
                    <div id="step-package" class="hidden mb-6">
                        <label class="block text-gray-600 text-sm font-semibold mb-2" for="id_package_id">
                            Tutar SeÃ§imi
                        </label>
                        <div class="relative">
                            <select id="id_package_id" name="package_id"
                                class="block appearance-none w-full bg-white border border-gray-400 hover:border-gray-500 px-4 py-2 pr-8 rounded shadow leading-tight focus:outline-none focus:shadow-outline">
                                <option value="">Tutar SeÃ§iniz</option>
                            </select>
                            <div
                                class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                                <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg"
                                    viewBox="0 0 20 20">
                                    <path
                                        d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z" />
                                </svg>
                            </div>
                        </div>
                    </div>

                    <!-- Step 3: Card Selection (Hidden initially) -->
                    <div id="step-card" class="hidden mb-6">
                        <label class="block text-gray-600 text-sm font-semibold mb-2" for="id_card_id">
                            Kart SeÃ§imi
                        </label>
                        <div class="relative">
                            <select name="card_id" id="id_card_id"
                                class="block appearance-none w-full bg-white border border-gray-400 hover:border-gray-500 px-4 py-2 pr-8 rounded shadow leading-tight focus:outline-none focus:shadow-outline">
                                <option value="">Kart SeÃ§iniz</option>
                                {% for card in cards %}
                                <option value="{{ card.id }}" {% if not card.can_be_used %}disabled{% endif %}>
                                    {{ card.alias }} (**** {{ card.card_number|slice:"-4:" }})
                                    {% if not card.can_be_used %} (Limit Doldu){% endif %}
                                </option>
                                {% endfor %}
                            </select>
                            <div
                                class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                                <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg"
                                    viewBox="0 0 20 20">
                                    <path
                                        d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z" />
                                </svg>
                            </div>
                        </div>
                        <div class="mt-2 text-right">
                            <a href="{% url 'cards' %}" class="text-xs text-blue-500 hover:text-blue-700 font-bold">+
                                Yeni Kart Ekle</a>
                        </div>
                    </div>

                    <div class="flex items-center justify-between hidden">
                        <button id="submit-btn"
                            class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-xl focus:outline-none focus:shadow-outline transition transform hover:-translate-y-0.5 shadow-lg flex justify-center items-center"
                            type="button">
                            <span>TL YÃ¼kle</span>
                            <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
                            </svg>
                        </button>
                    </div>
                </form>
            </div>

            <script>
                document.addEventListener('DOMContentLoaded', function () {
                    const phoneInput = document.getElementById('id_phone_number');
                    const stepPhone = document.getElementById('step-phone');
                    const stepLoading = document.getElementById('step-loading');
                    const loadingText = document.getElementById('loading-text');

                    const loadingSpinner = document.getElementById('loading-spinner');
                    const errorIcon = document.getElementById('error-icon');

                    const stepPackage = document.getElementById('step-package');
                    const stepCard = document.getElementById('step-card');
                    const packageIdSelect = document.getElementById('id_package_id');
                    const cardIdSelect = document.getElementById('id_card_id');
                    const submitBtn = document.getElementById('submit-btn');
                    const dynamicStatus = document.getElementById('dynamic-status');
                    const retryCaptchaBtn = document.getElementById('retry-captcha-btn');
                    const warningBox = document.getElementById('warning-box');

                    let taskId = null;
                    let pollInterval = null;

                    phoneInput.addEventListener('input', function (e) {
                        const val = e.target.value.replace(/\D/g, '');
                        if ((val.length === 10 || val.length === 11) && !taskId) {
                            startTransaction(val);
                        }
                    });

                    function startTransaction(phone) {
                        phoneInput.setAttribute('disabled', 'true');
                        phoneInput.classList.add('bg-gray-100', 'text-gray-500', 'cursor-not-allowed', 'border-gray-200');

                        stepLoading.classList.remove('hidden');
                        loadingSpinner.classList.remove('hidden');
                        errorIcon.classList.add('hidden');
                        loadingText.textContent = "Sistem Kontrol Ediliyor...";

                        // Note: Passing transaction_type='TL' here!
                        fetch('{% url "init_transaction" %}', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value },
                            body: `phone_number=${phone}&transaction_type=TL`
                        })
                            .then(response => response.json())
                            .then(data => {
                                if (data.status === 'started') {
                                    taskId = data.task_id;
                                    startPolling();
                                } else {
                                    alert("Hata: " + data.error);
                                    resetUI();
                                }
                            })
                            .catch(err => { console.error(err); alert("Hata oluÅŸtu."); resetUI(); });
                    }

                    function startPolling() {
                        if (pollInterval) clearInterval(pollInterval);
                        pollInterval = setInterval(checkStatus, 2000);
                    }

                    let isPaymentSubmitted = false;

                    function checkStatus() {
                        if (!taskId) return;
                        fetch(`/api/check-transaction-status/${taskId}/`)
                            .then(response => response.json())
                            .then(data => {
                                const logs = data.logs || "";
                                let statusMsg = "Ä°ÅŸlem sÃ¼rdÃ¼rÃ¼lÃ¼yor...";
                                let detailMsg = "";

                                if (logs.includes("Navigating")) detailMsg = "Turkcell Sitesine BaÄŸlanÄ±lÄ±yor... ðŸŒ";
                                if (logs.includes("Selecting Upload Type: TL")) detailMsg = "TL YÃ¼kleme Modu SeÃ§iliyor... ðŸ’°";
                                if (logs.includes("Filling Phone")) detailMsg = "Numara Giriliyor... ðŸ“±";
                                if (logs.includes("Solving Captcha")) detailMsg = "GÃ¼venlik Kodu Ã‡Ã¶zÃ¼lÃ¼yor... ðŸ§©";
                                if (logs.includes("Captcha Solved")) detailMsg = "Kod Ã‡Ã¶zÃ¼ldÃ¼, SeÃ§enekler TaranÄ±yor... ðŸ“¦";
                                if (logs.includes("Scraping packages")) detailMsg = "TL TutarlarÄ± Ã‡ekiliyor... â³";
                                if (logs.includes("Scraped")) detailMsg = "Tutar Listesi HazÄ±rlanÄ±yor... ðŸ“‹";

                                // Only show 'Waiting for selection' if we haven't submitted payment yet
                                if (logs.includes("Waiting for user selection") && !isPaymentSubmitted) detailMsg = "SeÃ§im Bekleniyor... ðŸ‘‡";

                                if (logs.includes("Payment Submitted")) detailMsg = "Ã–deme OnaylandÄ±, GÃ¼venlik EkranÄ± Bekleniyor... ðŸ”’";
                                if (logs.includes("3DS_WAITING_SMS")) detailMsg = "SMS Åžifresi Bekleniyor... ðŸ“² LÃ¼tfen Telefonunuzu Kontrol Edin.";
                                if (logs.includes("3DS_SMS_RECEIVED")) detailMsg = "SMS AlÄ±ndÄ±, Åžifre Giriliyor... ðŸ”„";

                                // Errors
                                if (logs.includes("3DS_ERROR_LIMIT")) {
                                    clearInterval(pollInterval);
                                    detailMsg = "Kart limitiniz bu iÅŸlem iÃ§in yetersiz.";
                                    loadingText.textContent = "Limit Yetersiz! âŒ";
                                    dynamicStatus.textContent = detailMsg;
                                    loadingSpinner.classList.add('hidden');
                                    errorIcon.classList.remove('hidden');
                                    retryCaptchaBtn.classList.remove('hidden');
                                    warningBox.classList.add('hidden');
                                    return;
                                }

                                if (logs.includes("3DS_ERROR_MODAL")) {
                                    detailMsg = "Banka HatasÄ± AlgÄ±landÄ± âš ï¸";
                                }

                                if (logs.includes("Captcha Failed") || logs.includes("CAPTCHA_RETRY_LIMIT_EXCEEDED")) {
                                    clearInterval(pollInterval);
                                    loadingText.textContent = "GÃ¼venlik AÅŸÄ±lamadÄ± âŒ";
                                    dynamicStatus.textContent = "LÃ¼tfen tekrar deneyiniz.";
                                    loadingSpinner.classList.add('hidden');
                                    errorIcon.classList.remove('hidden');
                                    retryCaptchaBtn.classList.remove('hidden');
                                    warningBox.classList.add('hidden');
                                    return;
                                }

                                if (detailMsg !== "") {
                                    dynamicStatus.textContent = detailMsg;
                                    // Do NOT update loadingText here to avoid duplication
                                }

                                retryCaptchaBtn.onclick = function () {
                                    resetUI();
                                    retryCaptchaBtn.classList.add('hidden');
                                    warningBox.classList.remove('hidden');
                                    phoneInput.focus();
                                    phoneInput.value = "";
                                };

                                if (data.status === 'WAITING_SELECTION') {
                                    clearInterval(pollInterval);
                                    if (data.packages && data.packages.length > 0) {
                                        packageIdSelect.innerHTML = '<option value="">Tutar SeÃ§iniz</option>';
                                        // Sort by price number
                                        data.packages.sort((a, b) => a.price - b.price);

                                        data.packages.forEach(pkg => {
                                            const option = document.createElement('option');
                                            option.value = pkg.package_id;
                                            option.textContent = `${pkg.name} (${pkg.price} TL)`;
                                            packageIdSelect.appendChild(option);
                                        });
                                    }
                                    stepLoading.classList.add('hidden');
                                    stepPackage.classList.remove('hidden');
                                    stepCard.classList.remove('hidden');
                                    submitBtn.parentElement.classList.remove('hidden');
                                } else if (data.status === 'FAILED') {
                                    if (!logs.includes("CAPTCHA_RETRY_LIMIT_EXCEEDED")) {
                                        clearInterval(pollInterval);
                                        loadingText.textContent = "Ä°ÅŸlem BaÅŸarÄ±sÄ±z!";
                                        // dynamicStatus might have the last error log
                                        stepLoading.classList.remove('hidden');
                                        stepPackage.classList.add('hidden');
                                        stepCard.classList.add('hidden');
                                        submitBtn.parentElement.classList.add('hidden');
                                        loadingSpinner.classList.add('hidden');
                                        errorIcon.classList.remove('hidden');
                                        retryCaptchaBtn.classList.remove('hidden');
                                        warningBox.classList.add('hidden');
                                    }
                                } else if (data.status === 'SUCCESS') {
                                    clearInterval(pollInterval);
                                    loadingText.textContent = "TamamlandÄ±!";
                                    alert("Ä°ÅŸlem BaÅŸarÄ±lÄ±!");
                                    window.location.reload();
                                }
                            });
                    }

                    submitBtn.addEventListener('click', function () {
                        const packageId = packageIdSelect.value;
                        const cardSelect = document.getElementById('id_card_id');

                        if (!packageId || !cardSelect.value) { alert("LÃ¼tfen seÃ§im yapÄ±nÄ±z."); return; }

                        isPaymentSubmitted = true; // Use flag to filter logs

                        stepPackage.classList.add('hidden');
                        stepCard.classList.add('hidden');
                        submitBtn.parentElement.classList.add('hidden');

                        stepLoading.classList.remove('hidden');
                        loadingText.textContent = "Ã–deme Ä°ÅŸleniyor...";
                        dynamicStatus.textContent = "Banka ile iletiÅŸim kuruluyor...";

                        fetch('{% url "complete_transaction" %}', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value },
                            body: `task_id=${taskId}&package_id=${encodeURIComponent(packageId)}&card_id=${cardSelect.value}&phone_number=${phoneInput.value}`
                        }).then(r => r.json()).then(d => { if (d.status === 'resumed') startPolling(); });
                    });

                    function resetUI() {
                        phoneInput.removeAttribute('disabled');
                        phoneInput.classList.remove('bg-gray-100', 'cursor-not-allowed');
                        stepLoading.classList.add('hidden');
                        taskId = null;
                        if (pollInterval) clearInterval(pollInterval);
                    }
                });
            </script>

            <!-- RIGHT SIDE: Recent Orders Table (Shared with Dashboard, but maybe filtered? User said "son iÅŸlemler olacak") -->
            <div
                class="w-full md:w-2/3 bg-white/80 backdrop-blur-lg rounded-2xl shadow-xl p-4 sm:p-8 border border-white/20">
                <div class="flex items-center space-x-3 mb-6 border-b border-gray-100 pb-4">
                    <div class="bg-indigo-100 p-2 rounded-lg">
                        <svg class="w-6 h-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01">
                            </path>
                        </svg>
                    </div>
                    <h2 class="text-xl font-bold text-gray-800">Son Ä°ÅŸlemler</h2>
                </div>

                <!-- Filter Form -->
                <div
                    class="flex flex-col sm:flex-row justify-between items-center bg-gray-50/50 p-4 border-b border-gray-100 mb-4 rounded-t-xl">
                    <div
                        class="flex flex-col sm:flex-row items-center space-y-2 sm:space-y-0 sm:space-x-4 mb-4 sm:mb-0 w-full sm:w-auto">
                        <a href="{% url 'tl_load' %}"
                            class="px-4 py-2 rounded-lg text-sm font-bold transition whitespace-nowrap {% if is_filtered_by_24h %}bg-green-600 text-white shadow-md{% else %}bg-white text-gray-600 hover:bg-gray-100 border border-gray-200{% endif %}">
                            Son 24 Saat
                        </a>

                        <div class="h-6 w-px bg-gray-300 hidden sm:block"></div>

                        <form method="GET" action="{% url 'tl_load' %}" class="flex items-center space-x-2">
                            <div class="flex items-center space-x-1">
                                <span class="text-xs text-gray-500 font-medium">Ara:</span>
                                <input type="text" name="phone_search"
                                    value="{{ query_params.phone_search|default_if_none:'' }}" placeholder="Telefon No"
                                    class="px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-green-500 w-32">
                            </div>

                            <div class="flex items-center space-x-1">
                                <span class="text-xs text-gray-500 font-medium">BaÅŸlangÄ±Ã§:</span>
                                <input type="date" name="start_date" value="{{ start_date }}"
                                    class="px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-green-500 w-36">
                            </div>

                            <div class="flex items-center space-x-1">
                                <span class="text-xs text-gray-500 font-medium">BitiÅŸ:</span>
                                <input type="date" name="end_date" value="{{ end_date }}"
                                    class="px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-green-500 w-36">
                            </div>

                            <button type="submit"
                                class="bg-gray-800 hover:bg-gray-700 text-white px-4 py-2 rounded-lg text-sm font-bold transition shadow-sm ml-2">
                                Filtrele
                            </button>
                        </form>
                    </div>
                </div>

                <div class="overflow-x-auto rounded-xl border border-gray-100">
                    <table class="min-w-full leading-normal">
                        <thead>
                            <tr class="bg-gray-50/50 text-gray-600 uppercase text-xs font-bold tracking-wider">
                                <th class="px-5 py-4 text-left">Telefon</th>
                                <th class="px-5 py-4 text-left">Tutar</th>
                                <th class="px-5 py-4 text-left">Durum</th>
                                <th class="px-5 py-4 text-left">Tarih</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            {% for order in orders %}
                            <tr class="hover:bg-blue-50/30 transition duration-150 ease-in-out">
                                <td class="px-5 py-4 bg-white text-sm font-medium text-gray-700">
                                    {{ order.phone_number }}
                                </td>
                                <td class="px-5 py-4 bg-white text-sm text-gray-600">
                                    {{ order.amount|default:order.package_id }} TL
                                </td>
                                <td class="px-5 py-4 bg-white text-sm">
                                    {% if order.status == 'COMPLETED' %}
                                    <span
                                        class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">TamamlandÄ±</span>
                                    {% elif order.status == 'FAILED' %}
                                    <span
                                        class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">Hata</span>
                                    {% else %}
                                    <span <span
                                        class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">{{
                                        order.get_status_display }}</span>
                                    {% endif %}
                                    {% if order.balance_went_negative %}
                                    <span
                                        class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-orange-100 text-orange-800 ml-1"
                                        title="Bu iÅŸlem sÄ±rasÄ±nda kart bakiyesi eksiye dÃ¼ÅŸtÃ¼">
                                        âš  Eksi bakiye
                                    </span>
                                    {% endif %}
                                </td>
                                <td class="px-5 py-4 bg-white text-sm text-gray-500">
                                    {{ order.created_at|date:"d M H:i" }}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="px-5 py-8 text-center text-gray-400 text-sm">
                                    HenÃ¼z iÅŸlem yok.
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div
                    class="px-5 py-5 bg-white border-t border-gray-100 flex flex-col xs:flex-row items-center justify-between">
                    <span class="text-xs text-gray-600">
                        Toplam {{ orders.paginator.count }} iÅŸlem, Sayfa {{ orders.number }} / {{
                        orders.paginator.num_pages }}
                    </span>
                    <div class="inline-flex mt-2 xs:mt-0">
                        {% if orders.has_previous %}
                        <a href="?page={{ orders.previous_page_number }}{% if query_params.phone_search %}&phone_search={{ query_params.phone_search }}{% endif %}{% if start_date %}&start_date={{ start_date }}{% endif %}{% if end_date %}&end_date={{ end_date }}{% endif %}"
                            class="text-sm bg-gray-100 hover:bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-l">
                            Ã–nceki
                        </a>
                        {% endif %}
                        {% if orders.has_next %}
                        <a href="?page={{ orders.next_page_number }}{% if query_params.phone_search %}&phone_search={{ query_params.phone_search }}{% endif %}{% if start_date %}&start_date={{ start_date }}{% endif %}{% if end_date %}&end_date={{ end_date }}{% endif %}"
                            class="text-sm bg-gray-100 hover:bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-r">
                            Sonraki
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>

        </div>
    </div>
</body>

</html>